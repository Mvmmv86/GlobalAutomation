#!/bin/bash
# ========================================
# SETUP SERVIDOR - GlobalAutomation
# ========================================
# Instala todas as depend√™ncias necess√°rias
# Sistema: Ubuntu 22.04 LTS
# RAM: 1GB (m√≠nimo)
# Tempo estimado: 10-15 minutos

set -e  # Parar em caso de erro

echo "========================================="
echo "üöÄ SETUP SERVIDOR - GlobalAutomation"
echo "========================================="
echo ""

# Verificar se est√° rodando como root
if [ "$EUID" -ne 0 ]; then
   echo "‚ùå Por favor, execute como root: sudo bash 02-SETUP-SERVER.sh"
   exit 1
fi

# Verificar mem√≥ria dispon√≠vel
TOTAL_RAM=$(free -m | awk '/^Mem:/{print $2}')
echo "üíæ RAM Total: ${TOTAL_RAM}MB"
if [ "$TOTAL_RAM" -lt 900 ]; then
    echo "‚ö†Ô∏è  AVISO: RAM baixa detectada. Recomendamos 2GB para melhor performance."
fi
echo ""

# ========================================
# FASE 1: Atualizar Sistema
# ========================================
echo "üì¶ FASE 1: Atualizando sistema..."
apt update
apt upgrade -y
echo "‚úÖ Sistema atualizado"
echo ""

# ========================================
# FASE 2: Instalar Python 3.11
# ========================================
echo "üêç FASE 2: Instalando Python 3.11..."

# Adicionar reposit√≥rio deadsnakes
apt install -y software-properties-common
add-apt-repository -y ppa:deadsnakes/ppa
apt update

# Instalar Python 3.11
apt install -y python3.11 python3.11-venv python3.11-dev python3-pip
apt install -y build-essential libssl-dev libffi-dev

# Verificar vers√£o
python3.11 --version
echo "‚úÖ Python 3.11 instalado"
echo ""

# ========================================
# FASE 3: Instalar Node.js 18
# ========================================
echo "üìó FASE 3: Instalando Node.js 18..."

# Adicionar reposit√≥rio NodeSource
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -

# Instalar Node.js
apt install -y nodejs

# Verificar vers√µes
node --version
npm --version
echo "‚úÖ Node.js 18 instalado"
echo ""

# ========================================
# FASE 4: Instalar PM2 (Process Manager)
# ========================================
echo "‚öôÔ∏è  FASE 4: Instalando PM2..."

npm install -g pm2

# Configurar PM2 para iniciar no boot
pm2 startup systemd -u root --hp /root

echo "‚úÖ PM2 instalado"
echo ""

# ========================================
# FASE 5: Instalar Nginx
# ========================================
echo "üåê FASE 5: Instalando Nginx..."

apt install -y nginx

# Iniciar Nginx
systemctl start nginx
systemctl enable nginx

# Verificar status
systemctl status nginx --no-pager

echo "‚úÖ Nginx instalado e rodando"
echo ""

# ========================================
# FASE 6: Instalar Certbot (SSL - Opcional)
# ========================================
echo "üîí FASE 6: Instalando Certbot (para SSL)..."

apt install -y certbot python3-certbot-nginx

echo "‚úÖ Certbot instalado"
echo ""

# ========================================
# FASE 7: Configurar Firewall
# ========================================
echo "üî• FASE 7: Configurando Firewall (UFW)..."

# Instalar UFW
apt install -y ufw

# Permitir SSH (IMPORTANTE!)
ufw allow 22/tcp
ufw allow OpenSSH

# Permitir HTTP/HTTPS
ufw allow 80/tcp
ufw allow 443/tcp

# Habilitar firewall (n√£o bloquear SSH!)
yes | ufw enable

# Ver status
ufw status

echo "‚úÖ Firewall configurado"
echo ""

# ========================================
# FASE 8: Instalar Git
# ========================================
echo "üìö FASE 8: Instalando Git..."

apt install -y git

git --version
echo "‚úÖ Git instalado"
echo ""

# ========================================
# FASE 9: Configurar Swap (para 1GB RAM)
# ========================================
echo "üíø FASE 9: Configurando Swap..."

# Verificar se j√° existe swap
if [ $(swapon --show | wc -l) -eq 0 ]; then
    echo "Criando arquivo de swap de 2GB..."

    # Criar arquivo swap
    fallocate -l 2G /swapfile
    chmod 600 /swapfile
    mkswap /swapfile
    swapon /swapfile

    # Tornar permanente
    echo '/swapfile none swap sw 0 0' >> /etc/fstab

    # Configurar swappiness (usar swap menos frequentemente)
    sysctl vm.swappiness=10
    echo 'vm.swappiness=10' >> /etc/sysctl.conf

    echo "‚úÖ Swap criado e ativado (2GB)"
else
    echo "‚úÖ Swap j√° existe"
fi

# Mostrar swap
free -h
echo ""

# ========================================
# FASE 10: Criar Estrutura de Diret√≥rios
# ========================================
echo "üìÅ FASE 10: Criando estrutura de diret√≥rios..."

mkdir -p /opt/trading-platform
mkdir -p /var/log/trading-platform

echo "‚úÖ Diret√≥rios criados"
echo ""

# ========================================
# FASE 11: Instalar Depend√™ncias do Sistema
# ========================================
echo "üîß FASE 11: Instalando depend√™ncias adicionais..."

apt install -y curl wget unzip htop nano vim

echo "‚úÖ Depend√™ncias instaladas"
echo ""

# ========================================
# RESUMO FINAL
# ========================================
echo "========================================="
echo "‚úÖ SETUP COMPLETO!"
echo "========================================="
echo ""
echo "üìã RESUMO:"
echo "  ‚úÖ Python 3.11:   $(python3.11 --version)"
echo "  ‚úÖ Node.js:       $(node --version)"
echo "  ‚úÖ npm:           $(npm --version)"
echo "  ‚úÖ PM2:           $(pm2 --version)"
echo "  ‚úÖ Nginx:         Rodando"
echo "  ‚úÖ Git:           $(git --version)"
echo "  ‚úÖ Firewall:      Ativo (22, 80, 443)"
echo "  ‚úÖ Swap:          2GB configurado"
echo ""
echo "üíæ Uso de RAM:"
free -h
echo ""
echo "üéØ PR√ìXIMO PASSO:"
echo "   1. Clone o reposit√≥rio:"
echo "      cd /opt/trading-platform"
echo "      git clone https://github.com/Mvmmv86/GlobalAutomation.git"
echo ""
echo "   2. Configure o .env:"
echo "      cd GlobalAutomation"
echo "      cp deploy/.env.production.example apps/api-python/.env"
echo "      nano apps/api-python/.env"
echo ""
echo "   3. Execute o deploy do backend:"
echo "      bash deploy/03-DEPLOY-BACKEND.sh"
echo ""
echo "========================================="
