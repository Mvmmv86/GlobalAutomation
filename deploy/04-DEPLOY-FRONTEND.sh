#!/bin/bash
# ========================================
# DEPLOY FRONTEND - GlobalAutomation
# ========================================
# Build e deploy do frontend React + Vite
# Tempo estimado: 3-5 minutos

set -e  # Parar em caso de erro

echo "========================================="
echo "üöÄ DEPLOY FRONTEND - React + Vite"
echo "========================================="
echo ""

# Verificar se est√° no diret√≥rio correto
if [ ! -f "frontend-new/package.json" ]; then
    echo "‚ùå ERRO: Execute este script na raiz do projeto GlobalAutomation"
    echo "   cd /opt/trading-platform/GlobalAutomation"
    echo "   bash deploy/04-DEPLOY-FRONTEND.sh"
    exit 1
fi

# ========================================
# FASE 1: Configurar .env do Frontend
# ========================================
echo "‚öôÔ∏è  FASE 1: Configurando .env do frontend..."

cd frontend-new

# Obter IP p√∫blico do servidor
PUBLIC_IP=$(curl -s http://ifconfig.me)

# Criar .env de produ√ß√£o
cat > .env << EOF
# API URL - AJUSTE CONFORME SEU DOM√çNIO!
# Se voc√™ configurou dom√≠nio:
#   VITE_API_URL=https://api.seudominio.com/api/v1
# Se est√° usando IP:
VITE_API_URL=http://${PUBLIC_IP}:8000/api/v1

# Environment
VITE_NODE_ENV=production

# Application
VITE_APP_NAME=Trading Platform
VITE_APP_VERSION=1.0.0
EOF

echo "‚úÖ .env criado com API_URL: http://${PUBLIC_IP}:8000/api/v1"
echo ""
echo "‚ö†Ô∏è  IMPORTANTE: Se voc√™ configurar dom√≠nio, edite:"
echo "   nano frontend-new/.env"
echo "   Altere VITE_API_URL para https://api.seudominio.com/api/v1"
echo ""

# ========================================
# FASE 2: Instalar Depend√™ncias
# ========================================
echo "üì¶ FASE 2: Instalando depend√™ncias npm..."

# Limpar node_modules e cache se existir
if [ -d "node_modules" ]; then
    echo "  Limpando node_modules antigo..."
    rm -rf node_modules
fi

# Instalar depend√™ncias
npm install --production=false

echo "‚úÖ Depend√™ncias instaladas"
echo ""

# ========================================
# FASE 3: Build para Produ√ß√£o
# ========================================
echo "üèóÔ∏è  FASE 3: Buildando para produ√ß√£o..."

# Remover build antigo
if [ -d "dist" ]; then
    rm -rf dist
fi

# Build
npm run build

# Verificar se build foi criado
if [ ! -d "dist" ]; then
    echo "‚ùå ERRO: Build falhou! Diret√≥rio dist/ n√£o foi criado."
    exit 1
fi

echo "‚úÖ Build criado em frontend-new/dist/"
echo ""

# ========================================
# FASE 4: Verificar Build
# ========================================
echo "üîç FASE 4: Verificando build..."

# Contar arquivos
FILE_COUNT=$(find dist -type f | wc -l)
echo "  üìÅ Arquivos no build: $FILE_COUNT"

# Tamanho total
BUILD_SIZE=$(du -sh dist | cut -f1)
echo "  üíæ Tamanho do build: $BUILD_SIZE"

# Verificar index.html
if [ ! -f "dist/index.html" ]; then
    echo "‚ùå ERRO: index.html n√£o encontrado no build!"
    exit 1
fi

echo "‚úÖ Build v√°lido"
echo ""

# ========================================
# FASE 5: Configurar Nginx
# ========================================
echo "üåê FASE 5: Configurando Nginx..."

cd /opt/trading-platform/GlobalAutomation

# Copiar configura√ß√£o do Nginx
if [ -f "deploy/nginx-config.conf" ]; then
    cp deploy/nginx-config.conf /etc/nginx/sites-available/trading-platform

    # Criar link simb√≥lico se n√£o existir
    if [ ! -L /etc/nginx/sites-enabled/trading-platform ]; then
        ln -s /etc/nginx/sites-available/trading-platform /etc/nginx/sites-enabled/
    fi

    echo "‚úÖ Configura√ß√£o Nginx copiada"
else
    echo "‚ö†Ô∏è  nginx-config.conf n√£o encontrado, criando configura√ß√£o b√°sica..."

    cat > /etc/nginx/sites-available/trading-platform << 'EOF'
# Backend API
server {
    listen 80;
    server_name _;

    # API Backend
    location /api/ {
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Frontend
    location / {
        root /opt/trading-platform/GlobalAutomation/frontend-new/dist;
        try_files $uri $uri/ /index.html;
        index index.html;

        # Cache assets
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
}
EOF

    ln -sf /etc/nginx/sites-available/trading-platform /etc/nginx/sites-enabled/
    echo "‚úÖ Configura√ß√£o b√°sica criada"
fi

echo ""

# ========================================
# FASE 6: Testar Configura√ß√£o Nginx
# ========================================
echo "üß™ FASE 6: Testando configura√ß√£o Nginx..."

nginx -t

if [ $? -ne 0 ]; then
    echo "‚ùå ERRO: Configura√ß√£o Nginx inv√°lida!"
    exit 1
fi

echo "‚úÖ Configura√ß√£o Nginx OK"
echo ""

# ========================================
# FASE 7: Recarregar Nginx
# ========================================
echo "üîÑ FASE 7: Recarregando Nginx..."

systemctl reload nginx
systemctl status nginx --no-pager | head -10

echo "‚úÖ Nginx recarregado"
echo ""

# ========================================
# FASE 8: Testar Frontend
# ========================================
echo "üè• FASE 8: Testando frontend..."

# Aguardar Nginx carregar
sleep 2

# Testar se frontend est√° acess√≠vel
if curl -f http://localhost/ > /dev/null 2>&1; then
    echo "‚úÖ Frontend acess√≠vel!"
else
    echo "‚ö†Ô∏è  Aviso: Frontend pode n√£o estar acess√≠vel via localhost"
fi

echo ""

# ========================================
# RESUMO FINAL
# ========================================
echo "========================================="
echo "‚úÖ FRONTEND DEPLOY COMPLETO!"
echo "========================================="
echo ""
echo "üåê ACESSE O SISTEMA:"
echo "  URL: http://${PUBLIC_IP}/"
echo "  API: http://${PUBLIC_IP}/api/v1/health"
echo ""
echo "üìä ARQUITETURA:"
echo "  Frontend:  Nginx (porta 80) ‚Üí /frontend-new/dist/"
echo "  Backend:   Nginx (proxy)     ‚Üí localhost:8000"
echo ""
echo "‚öôÔ∏è  COMANDOS √öTEIS:"
echo "  Ver logs Nginx:    tail -f /var/log/nginx/access.log"
echo "  Reload Nginx:      systemctl reload nginx"
echo "  Status Nginx:      systemctl status nginx"
echo ""
echo "üîí PR√ìXIMO PASSO (Opcional):"
echo "   1. Configure dom√≠nio (DNS apontando para ${PUBLIC_IP})"
echo "   2. Instale SSL: certbot --nginx -d seudominio.com"
echo ""
echo "========================================="
