#!/bin/bash
# ========================================
# DEPLOY BACKEND - GlobalAutomation
# ========================================
# Deploy do backend FastAPI com PM2
# Tempo estimado: 5-10 minutos

set -e  # Parar em caso de erro

echo "========================================="
echo "üöÄ DEPLOY BACKEND - FastAPI + PM2"
echo "========================================="
echo ""

# Verificar se est√° no diret√≥rio correto
if [ ! -f "apps/api-python/main.py" ]; then
    echo "‚ùå ERRO: Execute este script na raiz do projeto GlobalAutomation"
    echo "   cd /opt/trading-platform/GlobalAutomation"
    echo "   bash deploy/03-DEPLOY-BACKEND.sh"
    exit 1
fi

# Verificar se .env existe
if [ ! -f "apps/api-python/.env" ]; then
    echo "‚ùå ERRO: Arquivo .env n√£o encontrado!"
    echo ""
    echo "Configure o .env primeiro:"
    echo "  1. cp deploy/.env.production.example apps/api-python/.env"
    echo "  2. nano apps/api-python/.env"
    echo "  3. Preencha com suas credenciais reais"
    exit 1
fi

# ========================================
# FASE 1: Criar Virtual Environment
# ========================================
echo "üêç FASE 1: Criando virtual environment..."

cd apps/api-python

# Remover venv antigo se existir
if [ -d "venv" ]; then
    echo "  Removendo venv antigo..."
    rm -rf venv
fi

# Criar novo venv com Python 3.11
python3.11 -m venv venv

# Ativar venv
source venv/bin/activate

echo "‚úÖ Virtual environment criado"
echo ""

# ========================================
# FASE 2: Instalar Depend√™ncias
# ========================================
echo "üì¶ FASE 2: Instalando depend√™ncias Python..."

# Upgrade pip
pip install --upgrade pip

# Instalar depend√™ncias
pip install -r requirements.txt

echo "‚úÖ Depend√™ncias instaladas"
echo ""

# ========================================
# FASE 3: Testar Configura√ß√£o
# ========================================
echo "üß™ FASE 3: Testando configura√ß√£o..."

# Testar importa√ß√£o do m√≥dulo principal
python -c "import main; print('‚úÖ Importa√ß√£o OK')"

# Verificar .env
python -c "
import os
from dotenv import load_dotenv
load_dotenv()
required = ['SECRET_KEY', 'DATABASE_URL', 'ENCRYPTION_KEY']
missing = [k for k in required if not os.getenv(k)]
if missing:
    print(f'‚ùå ERRO: Vari√°veis faltando no .env: {missing}')
    exit(1)
print('‚úÖ .env configurado corretamente')
"

echo ""

# ========================================
# FASE 4: Configurar PM2
# ========================================
echo "‚öôÔ∏è  FASE 4: Configurando PM2..."

cd /opt/trading-platform/GlobalAutomation

# Parar processo antigo se existir
pm2 delete trading-api 2>/dev/null || true

# Iniciar aplica√ß√£o com PM2
pm2 start apps/api-python/venv/bin/python \
    --name trading-api \
    --interpreter none \
    -- -m uvicorn main:app \
    --host 0.0.0.0 \
    --port 8000 \
    --workers 1 \
    --cwd /opt/trading-platform/GlobalAutomation/apps/api-python

# Salvar configura√ß√£o PM2
pm2 save

echo "‚úÖ PM2 configurado"
echo ""

# ========================================
# FASE 5: Aguardar Inicializa√ß√£o
# ========================================
echo "‚è≥ FASE 5: Aguardando inicializa√ß√£o..."

sleep 5

# Verificar se est√° rodando
pm2 status trading-api

echo ""

# ========================================
# FASE 6: Testar Health Check
# ========================================
echo "üè• FASE 6: Testando health check..."

# Tentar 5 vezes (app pode demorar um pouco)
for i in {1..5}; do
    if curl -f http://localhost:8000/health 2>/dev/null; then
        echo ""
        echo "‚úÖ Health check OK!"
        break
    else
        echo "  Tentativa $i/5..."
        sleep 2
    fi
done

echo ""

# ========================================
# FASE 7: Configurar Auto Sync
# ========================================
echo "üîÑ FASE 7: Configurando auto sync..."

# Parar auto_sync antigo se existir
pm2 delete trading-sync 2>/dev/null || true

# Verificar se script existe
if [ -f "apps/api-python/auto_sync.sh" ]; then
    chmod +x apps/api-python/auto_sync.sh

    # Iniciar auto_sync com PM2
    pm2 start apps/api-python/auto_sync.sh \
        --name trading-sync \
        --cwd /opt/trading-platform/GlobalAutomation/apps/api-python

    pm2 save

    echo "‚úÖ Auto sync configurado"
else
    echo "‚ö†Ô∏è  auto_sync.sh n√£o encontrado (opcional)"
fi

echo ""

# ========================================
# FASE 8: Ver Logs
# ========================================
echo "üìÑ FASE 8: √öltimas linhas do log..."

pm2 logs trading-api --lines 20 --nostream

echo ""

# ========================================
# RESUMO FINAL
# ========================================
echo "========================================="
echo "‚úÖ BACKEND DEPLOY COMPLETO!"
echo "========================================="
echo ""
echo "üìã STATUS:"
pm2 status
echo ""
echo "üåê ENDPOINTS:"
echo "  Health Check: http://localhost:8000/health"
echo "  API Docs:     http://localhost:8000/docs"
echo "  OpenAPI:      http://localhost:8000/openapi.json"
echo ""
echo "üìä COMANDOS √öTEIS:"
echo "  Ver logs:       pm2 logs trading-api"
echo "  Restart:        pm2 restart trading-api"
echo "  Stop:           pm2 stop trading-api"
echo "  Status:         pm2 status"
echo "  Monit:          pm2 monit"
echo ""
echo "üéØ PR√ìXIMO PASSO:"
echo "   bash deploy/04-DEPLOY-FRONTEND.sh"
echo ""
echo "========================================="
